databaseChangeLog:
  - changeSet:
      id: 1762208521617-1
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: order_sequence_pkey
                  defaultValueComputed: GENERATED ALWAYS AS (doc ->> '_id'::text) STORED
                  name: id
                  type: TEXT
            tableName: order_sequence
  - changeSet:
      id: 1762208521617-2
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: orders_pkey
                  name: id
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: orders
  - changeSet:
      id: 1762208521617-3
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: menu_pkey
                  name: id
                  startWith: 23
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: menu
  - changeSet:
      id: 1762208521617-4
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: registrations_pkey
                  name: id
                  startWith: 12
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: registrations
  - changeSet:
      id: 1762208521617-5
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: product_pkey
                  name: id
                  startWith: 3
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: product
  - changeSet:
      id: initialMenu
      author: stephenatwell
      changes:
        - loadUpdateData:
            file: reference-data/menu_v1.csv
            relativeToChangelogFile: true
            tableName: menu
            primaryKey: id
  - changeSet:
      id: initialProducts
      author: stephenatwell
      changes:
        - loadUpdateData:
            file: reference-data/product_v1.csv
            relativeToChangelogFile: true
            tableName: product
            primaryKey: id
  - changeSet:
      id: 1-add-json-fields-as-columns
      author: stephen.atwell@harness.io
      comment: Add separate columns for JSON fields in product table
      labels: schema-change
      changes:
        - addColumn:
            tableName: product
            columns:
              - column:
                  name: name
                  type: text
              - column:
                  name: type
                  type: text
              - column:
                  name: price
                  type: numeric
              - column:
                  name: vegetarian
                  type: boolean
      rollback:
        - dropColumn:
            tableName: product
            columnName: name
        - dropColumn:
            tableName: product
            columnName: type
        - dropColumn:
            tableName: product
            columnName: price
        - dropColumn:
            tableName: product
            columnName: vegetarian
  - changeSet:
      id: 2-populate-new-columns-from-json
      author: stephen.atwell@harness.io
      comment: Populate new columns with data from JSON doc column
      labels: data-migration
      changes:
        - sql:
            sql: |
              UPDATE product
              SET name = (doc->>'name'),
                  type = (doc->>'type'),
                  price = (doc->>'price')::numeric,
                  vegetarian = (doc->>'vegetarian')::boolean;
      rollback:
        - sql:
            sql: |
              UPDATE product
              SET name = NULL,
                  type = NULL,
                  price = NULL,
                  vegetarian = NULL;
  - changeSet:
      id: 3-create-trigger-json-to-columns
      author: stephen.atwell@harness.io
      comment: Create trigger to update columns when JSON is updated
      labels: trigger
      changes:
        - sql:
            sql: |
              CREATE OR REPLACE FUNCTION update_product_columns()
              RETURNS TRIGGER AS
              '
              BEGIN
                NEW.name = NEW.doc->>''name'';
                NEW.type = NEW.doc->>''type'';
                NEW.price = (NEW.doc->>''price'')::numeric;
                NEW.vegetarian = (NEW.doc->>''vegetarian'')::boolean;
                RETURN NEW;
              END;
              ' LANGUAGE plpgsql;

              CREATE TRIGGER product_doc_to_columns
              BEFORE UPDATE OF doc ON product
              FOR EACH ROW
              WHEN (OLD.doc IS DISTINCT FROM NEW.doc)
              EXECUTE FUNCTION update_product_columns();
      rollback:
        - sql:
            sql: |
              DROP TRIGGER IF EXISTS product_doc_to_columns ON product;
              DROP FUNCTION IF EXISTS update_product_columns();
  - changeSet:
      id: 4-create-trigger-columns-to-json
      author: stephen.atwell@harness.io
      comment: Create trigger to update JSON when columns are updated
      labels: trigger
      changes:
        - sql:
            sql: |
              CREATE OR REPLACE FUNCTION update_product_json()
              RETURNS TRIGGER AS
              '
              BEGIN
                NEW.doc = jsonb_build_object(
                  ''name'', NEW.name,
                  ''type'', NEW.type,
                  ''price'', NEW.price,
                  ''vegetarian'', NEW.vegetarian
                );
                RETURN NEW;
              END;
              ' LANGUAGE plpgsql;

              CREATE TRIGGER product_columns_to_doc
              BEFORE UPDATE OF name, type, price, vegetarian ON product
              FOR EACH ROW
              WHEN (
                OLD.name IS DISTINCT FROM NEW.name OR
                OLD.type IS DISTINCT FROM NEW.type OR
                OLD.price IS DISTINCT FROM NEW.price OR
                OLD.vegetarian IS DISTINCT FROM NEW.vegetarian
              )
              EXECUTE FUNCTION update_product_json();
      rollback:
        - sql:
            sql: |
              DROP TRIGGER IF EXISTS product_columns_to_doc ON product;
              DROP FUNCTION IF EXISTS update_product_json();
