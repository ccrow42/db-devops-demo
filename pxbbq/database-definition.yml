databaseChangeLog:
  - changeSet:
      id: 1762208521617-1
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: order_sequence_pkey
                  defaultValueComputed: GENERATED ALWAYS AS (doc ->> '_id'::text) STORED
                  name: id
                  type: TEXT
            tableName: order_sequence
  - changeSet:
      id: 1762208521617-2
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  #constraints:
                  #  nullable: false
                  #  primaryKey: true
                  #  primaryKeyName: orders_pkey
                  name: id
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: orders
  - changeSet:
      id: 1762208521617-3
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: menu_pkey
                  name: id
                  startWith: 23
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: menu
  - changeSet:
      id: 1762208521617-4
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: registrations_pkey
                  name: id
                  startWith: 12
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: registrations
  - changeSet:
      id: 1762208521617-5
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: product_pkey
                  name: id
                  startWith: 3
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: product
  - changeSet:
      id: initialMenu
      author: stephenatwell
      changes:
        - loadUpdateData:
            file: reference-data/menu_v1.csv
            relativeToChangelogFile: true
            tableName: menu
            primaryKey: id
  - changeSet:
      id: initialProducts
      author: stephenatwell
      changes:
        - delete:
            tableName: product
        - loadUpdateData:
            file: reference-data/product_v1.csv
            relativeToChangelogFile: true
            tableName: product
            primaryKey: id
      rollback:
        - delete:
            tableName: product
  - changeSet:
      id: initialLogins
      author: stephenatwell
      changes:
        - delete:
            tableName: registrations
        - loadUpdateData:
            file: reference-data/registrations_v1.csv
            relativeToChangelogFile: true
            tableName: registrations
            primaryKey: id
      rollback:
        - delete:
            tableName: registrations
  - changeSet:
      id: initialOrders-prod
      context: prodonly
      author: stephenatwell
      changes:
        - delete:
            tableName: orders
        - loadUpdateData:
            file: reference-data/orders_v1.csv
            relativeToChangelogFile: true
            tableName: orders
            primaryKey: id
      rollback:
        - delete:
            tableName: registrations
  - changeSet:
      id: demostart
      author: stephenatwell
      changes:
        - tagDatabase:
            tag: demo-reset
  - changeSet:
      id: extract-json-fields-from-doc-column-20251115002120
      author: Stephen Atwell
      comment: Add columns for each JSON field in the doc column
      labels: myticket-123
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: main
                  type: text
      rollback:
        - dropColumn:
            tableName: orders
            columnName: main
  - changeSet:
      id: extract-json-fields-from-doc-column-drink-20251115002120
      author: Stephen Atwell
      comment: Add drink column from JSON doc
      labels: myticket-123
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: drink
                  type: text
      rollback:
        - dropColumn:
            tableName: orders
            columnName: drink
  - changeSet:
      id: extract-json-fields-from-doc-column-email-20251115002120
      author: Stephen Atwell
      comment: Add email column from JSON doc
      labels: myticket-123
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: email
                  type: text
      rollback:
        - dropColumn:
            tableName: orders
            columnName: email
  - changeSet:
      id: extract-json-fields-from-doc-column-side1-20251115002120
      author: Stephen Atwell
      comment: Add side1 column from JSON doc
      labels: myticket-123
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: side1
                  type: text
      rollback:
        - dropColumn:
            tableName: orders
            columnName: side1
  - changeSet:
      id: extract-json-fields-from-doc-column-side2-20251115002120
      author: Stephen Atwell
      comment: Add side2 column from JSON doc
      labels: myticket-123
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: side2
                  type: text
      rollback:
        - dropColumn:
            tableName: orders
            columnName: side2
  - changeSet:
      id: extract-json-fields-from-doc-column-orderid-20251115002120
      author: Stephen Atwell
      comment: Add orderid column from JSON doc
      labels: myticket-123
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: orderid
                  type: integer
      rollback:
        - dropColumn:
            tableName: orders
            columnName: orderid
  - changeSet:
      id: extract-json-fields-from-doc-column-orderdate-20251115002120
      author: Stephen Atwell
      comment: Add orderdate column from JSON doc
      labels: myticket-123
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: orderdate
                  type: timestamp
      rollback:
        - dropColumn:
            tableName: orders
            columnName: orderdate
  - changeSet:
      id: extract-json-fields-from-doc-column-orderstatus-20251115002120
      author: Stephen Atwell
      comment: Add orderstatus column from JSON doc
      labels: myticket-123
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: orderstatus
                  type: text
      rollback:
        - dropColumn:
            tableName: orders
            columnName: orderstatus
  - changeSet:
      id: create-trigger-to-sync-json-fields-20251115002120
      author: Stephen Atwell
      comment: Create trigger to keep JSON fields in sync with columns
      labels: myticket-123
      changes:
        - sql:
            splitStatements: false
            sql: |
              -- Function to update columns from doc JSON
              CREATE OR REPLACE FUNCTION sync_orders_json_to_columns()
              RETURNS TRIGGER AS $$
              BEGIN
                NEW.main = NEW.doc->>'Main';
                NEW.drink = NEW.doc->>'Drink';
                NEW.email = NEW.doc->>'Email';
                NEW.side1 = NEW.doc->>'Side1';
                NEW.side2 = NEW.doc->>'Side2';
                NEW.orderid = (NEW.doc->>'OrderId')::integer;
                NEW.orderdate = (NEW.doc->>'OrderDate')::timestamp;
                NEW.orderstatus = NEW.doc->>'OrderStatus';
                RETURN NEW;
              END;
              $$ LANGUAGE plpgsql;

              -- Trigger to update columns when doc is updated
              CREATE TRIGGER orders_doc_to_columns_trigger
              BEFORE INSERT OR UPDATE OF doc ON orders
              FOR EACH ROW
              EXECUTE FUNCTION sync_orders_json_to_columns();
      rollback:
        - sql:
            splitStatements: false
            sql: |
              DROP TRIGGER IF EXISTS orders_doc_to_columns_trigger ON orders;
              DROP FUNCTION IF EXISTS sync_orders_json_to_columns();
  - changeSet:
      id: create-trigger-to-sync-columns-to-json-20251115002120
      author: Stephen Atwell
      comment: Create trigger to keep columns in sync with JSON fields
      labels: myticket-123
      changes:
        - sql:
            splitStatements: false
            sql: "-- Function to update doc JSON from columns\nCREATE OR REPLACE FUNCTION sync_orders_columns_to_json()\nRETURNS TRIGGER AS $$\nBEGIN\n  IF (TG_OP = 'UPDATE' AND (\n     NEW.main IS DISTINCT FROM OLD.main OR\n     NEW.drink IS DISTINCT FROM OLD.drink OR\n     NEW.email IS DISTINCT FROM OLD.email OR\n     NEW.side1 IS DISTINCT FROM OLD.side1 OR\n     NEW.side2 IS DISTINCT FROM OLD.side2 OR\n     NEW.orderid IS DISTINCT FROM OLD.orderid OR\n     NEW.orderdate IS DISTINCT FROM OLD.orderdate OR\n     NEW.orderstatus IS DISTINCT FROM OLD.orderstatus)) THEN\n    \n    NEW.doc = jsonb_build_object(\n      'Main', NEW.main,\n      'Drink', NEW.drink,\n      'Email', NEW.email,\n      'Side1', NEW.side1,\n      'Side2', NEW.side2,\n      'OrderId', NEW.orderid,\n      'OrderDate', NEW.orderdate,\n      'OrderStatus', NEW.orderstatus\n    );\n  END IF;\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- Trigger to update doc when columns are updated\nCREATE TRIGGER orders_columns_to_doc_trigger\nBEFORE UPDATE OF main, drink, email, side1, side2, orderid, orderdate, orderstatus ON orders\nFOR EACH ROW\nEXECUTE FUNCTION sync_orders_columns_to_json();\n"
      rollback:
        - sql:
            splitStatements: false
            sql: |
              DROP TRIGGER IF EXISTS orders_columns_to_doc_trigger ON orders;
              DROP FUNCTION IF EXISTS sync_orders_columns_to_json();
  - changeSet:
      id: populate-columns-from-existing-json-20251115002120
      author: Stephen Atwell
      comment: Populate new columns from existing JSON data
      labels: myticket-123
      changes:
        - sql:
            splitStatements: false
            sql: "UPDATE orders\nSET \n  main = doc->>'Main',\n  drink = doc->>'Drink',\n  email = doc->>'Email',\n  side1 = doc->>'Side1',\n  side2 = doc->>'Side2',\n  orderid = (doc->>'OrderId')::integer,\n  orderdate = (doc->>'OrderDate')::timestamp,\n  orderstatus = doc->>'OrderStatus';\n"
      rollback:
        - sql:
            splitStatements: false
            sql: "UPDATE orders\nSET \n  main = NULL,\n  drink = NULL,\n  email = NULL,\n  side1 = NULL,\n  side2 = NULL,\n  orderid = NULL,\n  orderdate = NULL,\n  orderstatus = NULL;\n"
