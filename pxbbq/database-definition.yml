databaseChangeLog:
  - changeSet:
      id: 1762208521617-1
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: order_sequence_pkey
                  defaultValueComputed: GENERATED ALWAYS AS (doc ->> '_id'::text) STORED
                  name: id
                  type: TEXT
            tableName: order_sequence
  - changeSet:
      id: 1762208521617-2
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: orders_pkey
                  name: id
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: orders
  - changeSet:
      id: 1762208521617-3
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: menu_pkey
                  name: id
                  startWith: 23
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: menu
  - changeSet:
      id: 1762208521617-4
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: registrations_pkey
                  name: id
                  startWith: 12
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: registrations
  - changeSet:
      id: 1762208521617-5
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: product_pkey
                  name: id
                  startWith: 3
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: product
  - changeSet:
      id: initialMenu
      author: stephenatwell
      changes:
        - loadUpdateData:
            file: reference-data/menu_v1.csv
            relativeToChangelogFile: true
            tableName: menu
            primaryKey: id
  - changeSet:
      id: initialProducts
      author: stephenatwell
      changes:
        - delete:
            tableName: product
        - loadUpdateData:
            file: reference-data/product_v1.csv
            relativeToChangelogFile: true
            tableName: product
            primaryKey: id
      rollback:
        - delete:
            tableName: product
  - changeSet:
      id: extract-json-fields-from-orders-doc-column-20251105-1331
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Add separate columns for each JSON field from doc column
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: main
                  type: TEXT
      rollback:
        - dropColumn:
            tableName: orders
            columnName: main
  - changeSet:
      id: extract-json-fields-from-orders-doc-column-20251105-1332
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Add drink column from doc JSON
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: drink
                  type: TEXT
      rollback:
        - dropColumn:
            tableName: orders
            columnName: drink
  - changeSet:
      id: extract-json-fields-from-orders-doc-column-20251105-1333
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Add email column from doc JSON
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: email
                  type: TEXT
      rollback:
        - dropColumn:
            tableName: orders
            columnName: email
  - changeSet:
      id: extract-json-fields-from-orders-doc-column-20251105-1334
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Add side1 column from doc JSON
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: side1
                  type: TEXT
      rollback:
        - dropColumn:
            tableName: orders
            columnName: side1
  - changeSet:
      id: extract-json-fields-from-orders-doc-column-20251105-1335
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Add side2 column from doc JSON
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: side2
                  type: TEXT
      rollback:
        - dropColumn:
            tableName: orders
            columnName: side2
  - changeSet:
      id: extract-json-fields-from-orders-doc-column-20251105-1336
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Add orderId column from doc JSON
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: order_id
                  type: INTEGER
      rollback:
        - dropColumn:
            tableName: orders
            columnName: order_id
  - changeSet:
      id: extract-json-fields-from-orders-doc-column-20251105-1337
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Add orderDate column from doc JSON
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: order_date
                  type: TIMESTAMP
      rollback:
        - dropColumn:
            tableName: orders
            columnName: order_date
  - changeSet:
      id: extract-json-fields-from-orders-doc-column-20251105-1338
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Add orderStatus column from doc JSON
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: order_status
                  type: TEXT
      rollback:
        - dropColumn:
            tableName: orders
            columnName: order_status
  - changeSet:
      id: populate-new-columns-from-doc-json-20251105-1339
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Populate new columns with data from doc JSON
      changes:
        - sql:
            splitStatements: false
            sql: "UPDATE orders SET \n  main = doc->>'Main',\n  drink = doc->>'Drink',\n  email = doc->>'Email',\n  side1 = doc->>'Side1',\n  side2 = doc->>'Side2',\n  order_id = (doc->>'OrderId')::INTEGER,\n  order_date = (doc->>'OrderDate')::TIMESTAMP,\n  order_status = doc->>'OrderStatus';\n"
      rollback:
        - sql:
            splitStatements: false
            sql: |
              -- No rollback needed as original doc column is preserved
  - changeSet:
      id: create-trigger-for-doc-to-columns-sync-20251105-1340
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Create trigger to sync from doc column to individual columns
      changes:
        - sql:
            splitStatements: false
            sql: |
              CREATE OR REPLACE FUNCTION sync_doc_to_columns()
              RETURNS TRIGGER AS $$
              BEGIN
                NEW.main = NEW.doc->>'Main';
                NEW.drink = NEW.doc->>'Drink';
                NEW.email = NEW.doc->>'Email';
                NEW.side1 = NEW.doc->>'Side1';
                NEW.side2 = NEW.doc->>'Side2';
                NEW.order_id = (NEW.doc->>'OrderId')::INTEGER;
                NEW.order_date = (NEW.doc->>'OrderDate')::TIMESTAMP;
                NEW.order_status = NEW.doc->>'OrderStatus';
                RETURN NEW;
              END;
              $$ LANGUAGE plpgsql;

              CREATE TRIGGER trigger_sync_doc_to_columns
              BEFORE UPDATE OR INSERT ON orders
              FOR EACH ROW
              WHEN (NEW.doc IS NOT NULL)
              EXECUTE FUNCTION sync_doc_to_columns();
      rollback:
        - sql:
            splitStatements: false
            sql: |
              DROP TRIGGER IF EXISTS trigger_sync_doc_to_columns ON orders;
              DROP FUNCTION IF EXISTS sync_doc_to_columns();
  - changeSet:
      id: create-trigger-for-columns-to-doc-sync-20251105-1341
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Create trigger to sync from individual columns to doc column
      changes:
        - sql:
            splitStatements: false
            sql: |
              CREATE OR REPLACE FUNCTION sync_columns_to_doc()
              RETURNS TRIGGER AS $$
              BEGIN
                NEW.doc = jsonb_build_object(
                  'Main', NEW.main,
                  'Drink', NEW.drink,
                  'Email', NEW.email,
                  'Side1', NEW.side1,
                  'Side2', NEW.side2,
                  'OrderId', NEW.order_id,
                  'OrderDate', NEW.order_date,
                  'OrderStatus', NEW.order_status
                );
                RETURN NEW;
              END;
              $$ LANGUAGE plpgsql;

              CREATE TRIGGER trigger_sync_columns_to_doc
              BEFORE UPDATE ON orders
              FOR EACH ROW
              WHEN (
                NEW.main IS DISTINCT FROM OLD.main OR
                NEW.drink IS DISTINCT FROM OLD.drink OR
                NEW.email IS DISTINCT FROM OLD.email OR
                NEW.side1 IS DISTINCT FROM OLD.side1 OR
                NEW.side2 IS DISTINCT FROM OLD.side2 OR
                NEW.order_id IS DISTINCT FROM OLD.order_id OR
                NEW.order_date IS DISTINCT FROM OLD.order_date OR
                NEW.order_status IS DISTINCT FROM OLD.order_status
              )
              EXECUTE FUNCTION sync_columns_to_doc();
      rollback:
        - sql:
            splitStatements: false
            sql: |
              DROP TRIGGER IF EXISTS trigger_sync_columns_to_doc ON orders;
              DROP FUNCTION IF EXISTS sync_columns_to_doc();
