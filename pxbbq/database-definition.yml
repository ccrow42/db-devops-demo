databaseChangeLog:
  - changeSet:
      id: 1762208521617-1
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: order_sequence_pkey
                  defaultValueComputed: GENERATED ALWAYS AS (doc ->> '_id'::text) STORED
                  name: id
                  type: TEXT
            tableName: order_sequence
  - changeSet:
      id: 1762208521617-2
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: orders_pkey
                  name: id
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: orders
  - changeSet:
      id: 1762208521617-3
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: menu_pkey
                  name: id
                  startWith: 23
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: menu
  - changeSet:
      id: 1762208521617-4
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: registrations_pkey
                  name: id
                  startWith: 12
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: registrations
  - changeSet:
      id: 1762208521617-5
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: product_pkey
                  name: id
                  startWith: 3
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: product
  - changeSet:
      id: initialMenu
      author: stephenatwell
      changes:
        - loadUpdateData:
            file: reference-data/menu_v1.csv
            relativeToChangelogFile: true
            tableName: menu
            primaryKey: id
  - changeSet:
      id: initialProducts
      author: stephenatwell
      changes:
        - delete:
            tableName: product
        - loadUpdateData:
            file: reference-data/product_v1.csv
            relativeToChangelogFile: true
            tableName: product
            primaryKey: id
      rollback:
        - delete:
            tableName: product
  - changeSet:
      id: initialLogins
      author: stephenatwell
      changes:
        - delete:
            tableName: registrations
        - loadUpdateData:
            file: reference-data/registrations_v1.csv
            relativeToChangelogFile: true
            tableName: registrations
            primaryKey: id
      rollback:
        - delete:
            tableName: registrations
  - changeSet:
      id: demostart
      author: stephenatwell
      changes:
        - tagDatabase:
            tag: demo-reset
  - changeSet:
      id: 2025-11-06-00-18-add-json-columns-to-orders-table
      author: stephen.atwell@harness.io
      comment: Add individual columns for each field in the doc JSON column
      labels: myticket-123
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: Main
                  type: VARCHAR(255)
              - column:
                  name: Drink
                  type: VARCHAR(255)
              - column:
                  name: Email
                  type: VARCHAR(255)
              - column:
                  name: Side1
                  type: VARCHAR(255)
              - column:
                  name: Side2
                  type: VARCHAR(255)
              - column:
                  name: OrderId
                  type: BIGINT
              - column:
                  name: OrderDate
                  type: TIMESTAMP
              - column:
                  name: OrderStatus
                  type: VARCHAR(50)
      rollback:
        - dropColumn:
            tableName: orders
            columnName: Main
        - dropColumn:
            tableName: orders
            columnName: Drink
        - dropColumn:
            tableName: orders
            columnName: Email
        - dropColumn:
            tableName: orders
            columnName: Side1
        - dropColumn:
            tableName: orders
            columnName: Side2
        - dropColumn:
            tableName: orders
            columnName: OrderId
        - dropColumn:
            tableName: orders
            columnName: OrderDate
        - dropColumn:
            tableName: orders
            columnName: OrderStatus
  - changeSet:
      id: 2025-11-06-00-18-populate-json-columns-from-doc
      author: stephen.atwell@harness.io
      comment: Populate the new columns with data from the doc JSON column
      labels: myticket-123
      changes:
        - sql:
            splitStatements: false
            sql: |
              UPDATE orders
              SET "Main" = doc->>'Main',
                  "Drink" = doc->>'Drink',
                  "Email" = doc->>'Email',
                  "Side1" = doc->>'Side1',
                  "Side2" = doc->>'Side2',
                  "OrderId" = (doc->>'OrderId')::BIGINT,
                  "OrderDate" = (doc->>'OrderDate')::TIMESTAMP,
                  "OrderStatus" = doc->>'OrderStatus';
      rollback:
        - sql:
            splitStatements: false
            sql: |
              UPDATE orders
              SET "Main" = NULL,
                  "Drink" = NULL,
                  "Email" = NULL,
                  "Side1" = NULL,
                  "Side2" = NULL,
                  "OrderId" = NULL,
                  "OrderDate" = NULL,
                  "OrderStatus" = NULL;
  - changeSet:
      id: 2025-11-06-00-18-create-trigger-for-doc-sync
      author: stephen.atwell@harness.io
      comment: Create trigger to keep doc JSON and individual columns in sync
      labels: myticket-123
      changes:
        - sql:
            splitStatements: false
            sql: "CREATE OR REPLACE FUNCTION sync_orders_columns()\nRETURNS TRIGGER AS $$\nBEGIN\n  IF TG_OP = 'UPDATE' THEN\n    -- When individual columns are updated, update the doc JSON\n    IF (NEW.\"Main\" IS DISTINCT FROM OLD.\"Main\" OR\n        NEW.\"Drink\" IS DISTINCT FROM OLD.\"Drink\" OR\n        NEW.\"Email\" IS DISTINCT FROM OLD.\"Email\" OR\n        NEW.\"Side1\" IS DISTINCT FROM OLD.\"Side1\" OR\n        NEW.\"Side2\" IS DISTINCT FROM OLD.\"Side2\" OR\n        NEW.\"OrderId\" IS DISTINCT FROM OLD.\"OrderId\" OR\n        NEW.\"OrderDate\" IS DISTINCT FROM OLD.\"OrderDate\" OR\n        NEW.\"OrderStatus\" IS DISTINCT FROM OLD.\"OrderStatus\") THEN\n      \n      NEW.doc = jsonb_build_object(\n        'Main', NEW.\"Main\",\n        'Drink', NEW.\"Drink\",\n        'Email', NEW.\"Email\",\n        'Side1', NEW.\"Side1\",\n        'Side2', NEW.\"Side2\",\n        'OrderId', NEW.\"OrderId\",\n        'OrderDate', NEW.\"OrderDate\",\n        'OrderStatus', NEW.\"OrderStatus\"\n      );\n    END IF;\n    \n    -- When doc JSON is updated, update individual columns\n    IF NEW.doc IS DISTINCT FROM OLD.doc THEN\n      NEW.\"Main\" = NEW.doc->>'Main';\n      NEW.\"Drink\" = NEW.doc->>'Drink';\n      NEW.\"Email\" = NEW.doc->>'Email';\n      NEW.\"Side1\" = NEW.doc->>'Side1';\n      NEW.\"Side2\" = NEW.doc->>'Side2';\n      NEW.\"OrderId\" = (NEW.doc->>'OrderId')::BIGINT;\n      NEW.\"OrderDate\" = (NEW.doc->>'OrderDate')::TIMESTAMP;\n      NEW.\"OrderStatus\" = NEW.doc->>'OrderStatus';\n    END IF;\n  END IF;\n  \n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER sync_orders_columns_trigger\nBEFORE UPDATE ON orders\nFOR EACH ROW\nEXECUTE FUNCTION sync_orders_columns();\n\n-- Trigger for INSERT operations\nCREATE OR REPLACE FUNCTION sync_orders_columns_insert()\nRETURNS TRIGGER AS $$\nBEGIN\n  -- For new rows with doc but no columns\n  IF NEW.doc IS NOT NULL AND (NEW.\"Main\" IS NULL OR NEW.\"Drink\" IS NULL) THEN\n    NEW.\"Main\" = NEW.doc->>'Main';\n    NEW.\"Drink\" = NEW.doc->>'Drink';\n    NEW.\"Email\" = NEW.doc->>'Email';\n    NEW.\"Side1\" = NEW.doc->>'Side1';\n    NEW.\"Side2\" = NEW.doc->>'Side2';\n    NEW.\"OrderId\" = (NEW.doc->>'OrderId')::BIGINT;\n    NEW.\"OrderDate\" = (NEW.doc->>'OrderDate')::TIMESTAMP;\n    NEW.\"OrderStatus\" = NEW.doc->>'OrderStatus';\n  -- For new rows with columns but no doc\n  ELSIF NEW.doc IS NULL AND (NEW.\"Main\" IS NOT NULL OR NEW.\"Drink\" IS NOT NULL) THEN\n    NEW.doc = jsonb_build_object(\n      'Main', NEW.\"Main\",\n      'Drink', NEW.\"Drink\",\n      'Email', NEW.\"Email\",\n      'Side1', NEW.\"Side1\",\n      'Side2', NEW.\"Side2\",\n      'OrderId', NEW.\"OrderId\",\n      'OrderDate', NEW.\"OrderDate\",\n      'OrderStatus', NEW.\"OrderStatus\"\n    );\n  END IF;\n  \n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER sync_orders_columns_insert_trigger\nBEFORE INSERT ON orders\nFOR EACH ROW\nEXECUTE FUNCTION sync_orders_columns_insert();\n"
      rollback:
        - sql:
            splitStatements: false
            sql: |
              DROP TRIGGER IF EXISTS sync_orders_columns_trigger ON orders;
              DROP FUNCTION IF EXISTS sync_orders_columns();
              DROP TRIGGER IF EXISTS sync_orders_columns_insert_trigger ON orders;
              DROP FUNCTION IF EXISTS sync_orders_columns_insert();
