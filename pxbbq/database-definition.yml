databaseChangeLog:
  - changeSet:
      id: 1762208521617-1
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: order_sequence_pkey
                  defaultValueComputed: GENERATED ALWAYS AS (doc ->> '_id'::text) STORED
                  name: id
                  type: TEXT
            tableName: order_sequence
  - changeSet:
      id: 1762208521617-2
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: orders_pkey
                  name: id
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: orders
  - changeSet:
      id: 1762208521617-3
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: menu_pkey
                  name: id
                  startWith: 23
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: menu
  - changeSet:
      id: 1762208521617-4
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: registrations_pkey
                  name: id
                  startWith: 12
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: registrations
  - changeSet:
      id: 1762208521617-5
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: product_pkey
                  name: id
                  startWith: 3
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: product
  - changeSet:
      id: initialMenu
      author: stephenatwell
      changes:
        - loadUpdateData:
            file: reference-data/menu_v1.csv
            relativeToChangelogFile: true
            tableName: menu
            primaryKey: id
  - changeSet:
      id: initialProducts
      author: stephenatwell
      changes:
        - loadUpdateData:
            file: reference-data/product_v1.csv
            relativeToChangelogFile: true
            tableName: product
            primaryKey: id
  - changeSet:
      id: 1699123456789-1
      author: stephen.atwell@harness.io
      comment: Add individual columns for JSON fields from doc column
      labels: schema-change
      changes:
        - addColumn:
            tableName: product
            columns:
              - column:
                  name: name
                  type: VARCHAR(255)
      rollback:
        - dropColumn:
            tableName: product
            columnName: name
  - changeSet:
      id: 1699123456789-2
      author: stephen.atwell@harness.io
      comment: Add type column from JSON doc
      labels: schema-change
      changes:
        - addColumn:
            tableName: product
            columns:
              - column:
                  name: type
                  type: VARCHAR(255)
      rollback:
        - dropColumn:
            tableName: product
            columnName: type
  - changeSet:
      id: 1699123456789-3
      author: stephen.atwell@harness.io
      comment: Add price column from JSON doc
      labels: schema-change
      changes:
        - addColumn:
            tableName: product
            columns:
              - column:
                  name: price
                  type: NUMERIC(10,2)
      rollback:
        - dropColumn:
            tableName: product
            columnName: price
  - changeSet:
      id: 1699123456789-4
      author: stephen.atwell@harness.io
      comment: Add vegetarian column from JSON doc
      labels: schema-change
      changes:
        - addColumn:
            tableName: product
            columns:
              - column:
                  name: vegetarian
                  type: BOOLEAN
      rollback:
        - dropColumn:
            tableName: product
            columnName: vegetarian
  - changeSet:
      id: 1699123456789-5
      author: stephen.atwell@harness.io
      comment: Populate new columns from JSON doc
      labels: data-migration
      changes:
        - sql:
            sql: "UPDATE product \nSET name = (doc->>'name'),\n    type = (doc->>'type'),\n    price = (doc->>'price')::NUMERIC,\n    vegetarian = (doc->>'vegetarian')::BOOLEAN;\n"
      rollback:
        - sql:
            sql: |
              -- No rollback needed as original doc column is preserved
  - changeSet:
      id: 1699123456789-6
      author: stephen.atwell@harness.io
      comment: Create trigger to keep doc and individual columns in sync
      labels: trigger
      changes:
        - sql:
            sql: "CREATE OR REPLACE FUNCTION sync_product_columns()\nRETURNS TRIGGER AS $$\nBEGIN\n  IF TG_OP = 'UPDATE' THEN\n    -- If doc column was updated, update individual columns\n    IF NEW.doc IS DISTINCT FROM OLD.doc THEN\n      NEW.name = NEW.doc->>'name';\n      NEW.type = NEW.doc->>'type';\n      NEW.price = (NEW.doc->>'price')::NUMERIC;\n      NEW.vegetarian = (NEW.doc->>'vegetarian')::BOOLEAN;\n    -- If individual columns were updated, update doc column\n    ELSIF (NEW.name IS DISTINCT FROM OLD.name) OR \n          (NEW.type IS DISTINCT FROM OLD.type) OR \n          (NEW.price IS DISTINCT FROM OLD.price) OR \n          (NEW.vegetarian IS DISTINCT FROM OLD.vegetarian) THEN\n      NEW.doc = jsonb_build_object(\n        'name', NEW.name,\n        'type', NEW.type,\n        'price', NEW.price,\n        'vegetarian', NEW.vegetarian\n      );\n    END IF;\n  END IF;\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER sync_product_columns_trigger\nBEFORE UPDATE ON product\nFOR EACH ROW\nEXECUTE FUNCTION sync_product_columns();\n\n-- Also handle INSERT operations\nCREATE OR REPLACE FUNCTION sync_product_columns_insert()\nRETURNS TRIGGER AS $$\nBEGIN\n  -- If doc is provided but individual columns are not\n  IF NEW.doc IS NOT NULL AND (NEW.name IS NULL OR NEW.type IS NULL OR NEW.price IS NULL OR NEW.vegetarian IS NULL) THEN\n    NEW.name = NEW.doc->>'name';\n    NEW.type = NEW.doc->>'type';\n    NEW.price = (NEW.doc->>'price')::NUMERIC;\n    NEW.vegetarian = (NEW.doc->>'vegetarian')::BOOLEAN;\n  -- If individual columns are provided but doc is not\n  ELSIF NEW.doc IS NULL AND (NEW.name IS NOT NULL OR NEW.type IS NOT NULL OR NEW.price IS NOT NULL OR NEW.vegetarian IS NOT NULL) THEN\n    NEW.doc = jsonb_build_object(\n      'name', NEW.name,\n      'type', NEW.type,\n      'price', NEW.price,\n      'vegetarian', NEW.vegetarian\n    );\n  END IF;\n  RETURN NEW;\nEND;\n$$ LANGUAGE plpgsql;\n\nCREATE TRIGGER sync_product_columns_insert_trigger\nBEFORE INSERT ON product\nFOR EACH ROW\nEXECUTE FUNCTION sync_product_columns_insert();\n"
      rollback:
        - sql:
            sql: |
              DROP TRIGGER IF EXISTS sync_product_columns_trigger ON product;
              DROP FUNCTION IF EXISTS sync_product_columns();
              DROP TRIGGER IF EXISTS sync_product_columns_insert_trigger ON product;
              DROP FUNCTION IF EXISTS sync_product_columns_insert();
