databaseChangeLog:
  - changeSet:
      id: 1762208521617-1
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: order_sequence_pkey
                  defaultValueComputed: GENERATED ALWAYS AS (doc ->> '_id'::text) STORED
                  name: id
                  type: TEXT
            tableName: order_sequence
  - changeSet:
      id: 1762208521617-2
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: orders_pkey
                  name: id
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: orders
  - changeSet:
      id: 1762208521617-3
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: menu_pkey
                  name: id
                  startWith: 23
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: menu
  - changeSet:
      id: 1762208521617-4
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: registrations_pkey
                  name: id
                  startWith: 12
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: registrations
  - changeSet:
      id: 1762208521617-5
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: product_pkey
                  name: id
                  startWith: 3
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: product
  - changeSet:
      id: initialMenu
      author: stephenatwell
      changes:
        - loadUpdateData:
            file: reference-data/menu_v1.csv
            relativeToChangelogFile: true
            tableName: menu
            primaryKey: id
  - changeSet:
      id: initialProducts
      author: stephenatwell
      changes:
        - delete:
            tableName: product
        - loadUpdateData:
            file: reference-data/product_v1.csv
            relativeToChangelogFile: true
            tableName: product
            primaryKey: id
      rollback:
        - delete:
            tableName: product
  - changeSet:
      id: 20251104141519_add_product_json_columns
      author: stephen.atwell@harness.io
      comment: Add separate columns for each JSON field in the doc column
      labels: myticket-123
      changes:
        - addColumn:
            tableName: product
            columns:
              - column:
                  name: name
                  type: text
              - column:
                  name: type
                  type: text
              - column:
                  name: price
                  type: numeric
              - column:
                  name: vegetarian
                  type: boolean
      rollback:
        - dropColumn:
            tableName: product
            columnName: name
        - dropColumn:
            tableName: product
            columnName: type
        - dropColumn:
            tableName: product
            columnName: price
        - dropColumn:
            tableName: product
            columnName: vegetarian
  - changeSet:
      id: 20251104141519_populate_product_columns_from_json
      author: stephen.atwell@harness.io
      comment: Populate new columns with data from existing JSON doc column
      labels: myticket-123
      changes:
        - sql:
            sql: |
              UPDATE product
              SET name = (doc->>'name'),
                  type = (doc->>'type'),
                  price = (doc->>'price')::numeric,
                  vegetarian = (doc->>'vegetarian')::boolean;
      rollback:
        - sql:
            sql: |
              UPDATE product
              SET name = NULL,
                  type = NULL,
                  price = NULL,
                  vegetarian = NULL;
  - changeSet:
      id: 20251104141519_create_doc_to_columns_trigger
      author: stephen.atwell@harness.io
      comment: Create trigger to sync JSON doc column to individual columns
      labels: myticket-123
      changes:
        - sql:
            sql: |
              CREATE OR REPLACE FUNCTION sync_doc_to_columns()
              RETURNS TRIGGER AS
              BEGIN
                NEW.name = NEW.doc->>'name';
                NEW.type = NEW.doc->>'type';
                NEW.price = (NEW.doc->>'price')::numeric;
                NEW.vegetarian = (NEW.doc->>'vegetarian')::boolean;
                RETURN NEW;
              END;

              CREATE TRIGGER product_doc_to_columns
              BEFORE UPDATE OR INSERT ON product
              FOR EACH ROW
              WHEN (NEW.doc IS DISTINCT FROM OLD.doc OR OLD.doc IS NULL)
              EXECUTE FUNCTION sync_doc_to_columns();
      rollback:
        - sql:
            sql: |
              DROP TRIGGER IF EXISTS product_doc_to_columns ON product;
              DROP FUNCTION IF EXISTS sync_doc_to_columns();
  - changeSet:
      id: 20251104141519_create_columns_to_doc_trigger
      author: stephen.atwell@harness.io
      comment: Create trigger to sync individual columns to JSON doc column
      labels: myticket-123
      changes:
        - sql:
            sql: |
              CREATE OR REPLACE FUNCTION sync_columns_to_doc()
              RETURNS TRIGGER AS
              BEGIN
                NEW.doc = jsonb_build_object(
                  'name', NEW.name,
                  'type', NEW.type,
                  'price', NEW.price,
                  'vegetarian', NEW.vegetarian
                );
                RETURN NEW;
              END;

              CREATE TRIGGER product_columns_to_doc
              BEFORE UPDATE OR INSERT ON product
              FOR EACH ROW
              WHEN (
                NEW.name IS DISTINCT FROM OLD.name OR
                NEW.type IS DISTINCT FROM OLD.type OR
                NEW.price IS DISTINCT FROM OLD.price OR
                NEW.vegetarian IS DISTINCT FROM OLD.vegetarian OR
                OLD.name IS NULL
              )
              EXECUTE FUNCTION sync_columns_to_doc();
      rollback:
        - sql:
            sql: |
              DROP TRIGGER IF EXISTS product_columns_to_doc ON product;
              DROP FUNCTION IF EXISTS sync_columns_to_doc();
  - changeSet:
      id: 20251105-1701-add-columns-from-doc-json
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Add separate columns for JSON fields from doc column
      changes:
        - addColumn:
            tableName: menu
            columns:
              - column:
                  name: name
                  type: text
      rollback:
        - dropColumn:
            tableName: menu
            columnName: name
  - changeSet:
      id: 20251105-1701-add-type-column
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Add type column from doc JSON
      changes:
        - addColumn:
            tableName: menu
            columns:
              - column:
                  name: type
                  type: text
      rollback:
        - dropColumn:
            tableName: menu
            columnName: type
  - changeSet:
      id: 20251105-1701-add-price-column
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Add price column from doc JSON
      changes:
        - addColumn:
            tableName: menu
            columns:
              - column:
                  name: price
                  type: decimal(10,2)
      rollback:
        - dropColumn:
            tableName: menu
            columnName: price
  - changeSet:
      id: 20251105-1701-add-vegetarian-column
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Add vegetarian column from doc JSON
      changes:
        - addColumn:
            tableName: menu
            columns:
              - column:
                  name: vegetarian
                  type: boolean
      rollback:
        - dropColumn:
            tableName: menu
            columnName: vegetarian
  - changeSet:
      id: 20251105-1701-populate-columns-from-doc
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Populate new columns with data from doc JSON
      changes:
        - sql:
            sql: |
              UPDATE menu
              SET name = (doc->>'name'),
                  type = (doc->>'type'),
                  price = (doc->>'price')::decimal,
                  vegetarian = (doc->>'vegetarian')::boolean;
      rollback:
        - sql:
            sql: |
              UPDATE menu
              SET name = NULL,
                  type = NULL,
                  price = NULL,
                  vegetarian = NULL;
  - changeSet:
      id: 20251105-1701-create-trigger-doc-to-columns
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Create trigger to sync doc changes to columns
      changes:
        - sql:
            sql: |
              CREATE OR REPLACE FUNCTION sync_doc_to_columns()
              RETURNS TRIGGER AS
              $BODY$
              BEGIN
                NEW.name = NEW.doc->>'name';
                NEW.type = NEW.doc->>'type';
                NEW.price = (NEW.doc->>'price')::decimal;
                NEW.vegetarian = (NEW.doc->>'vegetarian')::boolean;
                RETURN NEW;
              END;
              $BODY$
              LANGUAGE plpgsql;

              CREATE TRIGGER menu_doc_to_columns
              BEFORE UPDATE OF doc ON menu
              FOR EACH ROW
              WHEN (OLD.doc IS DISTINCT FROM NEW.doc)
              EXECUTE FUNCTION sync_doc_to_columns();
      rollback:
        - sql:
            sql: |
              DROP TRIGGER IF EXISTS menu_doc_to_columns ON menu;
              DROP FUNCTION IF EXISTS sync_doc_to_columns();
  - changeSet:
      id: 20251105-1701-create-trigger-columns-to-doc
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Create trigger to sync column changes to doc
      changes:
        - sql:
            sql: |
              CREATE OR REPLACE FUNCTION sync_columns_to_doc()
              RETURNS TRIGGER AS
              $BODY$
              BEGIN
                NEW.doc = jsonb_build_object(
                  'name', NEW.name,
                  'type', NEW.type,
                  'price', NEW.price,
                  'vegetarian', NEW.vegetarian
                );
                RETURN NEW;
              END;
              $BODY$
              LANGUAGE plpgsql;

              CREATE TRIGGER menu_columns_to_doc
              BEFORE UPDATE OF name, type, price, vegetarian ON menu
              FOR EACH ROW
              WHEN (
                OLD.name IS DISTINCT FROM NEW.name OR
                OLD.type IS DISTINCT FROM NEW.type OR
                OLD.price IS DISTINCT FROM NEW.price OR
                OLD.vegetarian IS DISTINCT FROM NEW.vegetarian
              )
              EXECUTE FUNCTION sync_columns_to_doc();
      rollback:
        - sql:
            sql: |
              DROP TRIGGER IF EXISTS menu_columns_to_doc ON menu;
              DROP FUNCTION IF EXISTS sync_columns_to_doc();
  - changeSet:
      id: 20251105-add-columns-from-doc-json-1
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Add individual columns for each field in the doc JSON
      changes:
        - addColumn:
            tableName: menu
            columns:
              - column:
                  name: name
                  type: VARCHAR(255)
      rollback:
        - dropColumn:
            tableName: menu
            columnName: name
  - changeSet:
      id: 20251105-add-columns-from-doc-json-2
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Add type column from doc JSON
      changes:
        - addColumn:
            tableName: menu
            columns:
              - column:
                  name: type
                  type: VARCHAR(255)
      rollback:
        - dropColumn:
            tableName: menu
            columnName: type
  - changeSet:
      id: 20251105-add-columns-from-doc-json-3
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Add price column from doc JSON
      changes:
        - addColumn:
            tableName: menu
            columns:
              - column:
                  name: price
                  type: DECIMAL(10,2)
      rollback:
        - dropColumn:
            tableName: menu
            columnName: price
  - changeSet:
      id: 20251105-add-columns-from-doc-json-4
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Add vegetarian column from doc JSON
      changes:
        - addColumn:
            tableName: menu
            columns:
              - column:
                  name: vegetarian
                  type: BOOLEAN
      rollback:
        - dropColumn:
            tableName: menu
            columnName: vegetarian
  - changeSet:
      id: 20251105-populate-new-columns-from-doc
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Populate the new columns with data from the doc JSON column
      changes:
        - sql:
            sql: |
              UPDATE menu
              SET name = (doc->>'name'),
                  type = (doc->>'type'),
                  price = (doc->>'price')::DECIMAL(10,2),
                  vegetarian = (doc->>'vegetarian')::BOOLEAN;
      rollback:
        - sql:
            sql: |
              UPDATE menu
              SET name = NULL,
                  type = NULL,
                  price = NULL,
                  vegetarian = NULL;
  - changeSet:
      id: 20251105-create-trigger-for-doc-sync
      author: stephen.atwell@harness.io
      labels: myticket-123
      comment: Create trigger to keep doc JSON and individual columns in sync
      changes:
        - sql:
            sql: "CREATE OR REPLACE FUNCTION sync_menu_columns()\nRETURNS TRIGGER AS\n$BODY$\nBEGIN\n  IF TG_OP = 'UPDATE' THEN\n    -- When individual columns are updated, update the doc JSON\n    IF (NEW.name IS DISTINCT FROM OLD.name OR \n        NEW.type IS DISTINCT FROM OLD.type OR \n        NEW.price IS DISTINCT FROM OLD.price OR \n        NEW.vegetarian IS DISTINCT FROM OLD.vegetarian) THEN\n      \n      NEW.doc = jsonb_build_object(\n        'name', NEW.name,\n        'type', NEW.type,\n        'price', NEW.price,\n        'vegetarian', NEW.vegetarian\n      );\n    \n    -- When doc JSON is updated, update individual columns\n    ELSIF (NEW.doc IS DISTINCT FROM OLD.doc) THEN\n      NEW.name = NEW.doc->>'name';\n      NEW.type = NEW.doc->>'type';\n      NEW.price = (NEW.doc->>'price')::DECIMAL(10,2);\n      NEW.vegetarian = (NEW.doc->>'vegetarian')::BOOLEAN;\n    END IF;\n  END IF;\n  \n  RETURN NEW;\nEND;\n$BODY$\nLANGUAGE plpgsql;\n\nCREATE TRIGGER sync_menu_columns_trigger\nBEFORE UPDATE ON menu\nFOR EACH ROW\nEXECUTE FUNCTION sync_menu_columns();\n\n-- Trigger for INSERT operations\nCREATE OR REPLACE FUNCTION sync_menu_columns_insert()\nRETURNS TRIGGER AS\n$BODY$\nBEGIN\n  -- For new rows, ensure both doc and individual columns are populated\n  IF NEW.doc IS NOT NULL AND \n     (NEW.name IS NULL OR NEW.type IS NULL OR NEW.price IS NULL OR NEW.vegetarian IS NULL) THEN\n    -- Doc exists but columns don't - populate columns from doc\n    NEW.name = NEW.doc->>'name';\n    NEW.type = NEW.doc->>'type';\n    NEW.price = (NEW.doc->>'price')::DECIMAL(10,2);\n    NEW.vegetarian = (NEW.doc->>'vegetarian')::BOOLEAN;\n  ELSIF NEW.doc IS NULL AND \n        (NEW.name IS NOT NULL OR NEW.type IS NOT NULL OR \n         NEW.price IS NOT NULL OR NEW.vegetarian IS NOT NULL) THEN\n    -- Columns exist but doc doesn't - populate doc from columns\n    NEW.doc = jsonb_build_object(\n      'name', NEW.name,\n      'type', NEW.type,\n      'price', NEW.price,\n      'vegetarian', NEW.vegetarian\n    );\n  END IF;\n  \n  RETURN NEW;\nEND;\n$BODY$\nLANGUAGE plpgsql;\n\nCREATE TRIGGER sync_menu_columns_insert_trigger\nBEFORE INSERT ON menu\nFOR EACH ROW\nEXECUTE FUNCTION sync_menu_columns_insert();\n"
      rollback:
        - sql:
            sql: |
              DROP TRIGGER IF EXISTS sync_menu_columns_trigger ON menu;
              DROP FUNCTION IF EXISTS sync_menu_columns();
              DROP TRIGGER IF EXISTS sync_menu_columns_insert_trigger ON menu;
              DROP FUNCTION IF EXISTS sync_menu_columns_insert();
