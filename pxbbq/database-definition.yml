databaseChangeLog:
  - changeSet:
      id: 1762208521617-1
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
              - column:
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: order_sequence_pkey
                  defaultValueComputed: GENERATED ALWAYS AS (doc ->> '_id'::text) STORED
                  name: id
                  type: TEXT
            tableName: order_sequence
  - changeSet:
      id: 1762208521617-2
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: orders_pkey
                  name: id
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: orders
  - changeSet:
      id: 1762208521617-3
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: menu_pkey
                  name: id
                  startWith: 23
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: menu
  - changeSet:
      id: 1762208521617-4
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: registrations_pkey
                  name: id
                  startWith: 12
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: registrations
  - changeSet:
      id: 1762208521617-5
      author: stephenatwell (generated)
      changes:
        - createTable:
            columns:
              - column:
                  autoIncrement: true
                  constraints:
                    nullable: false
                    primaryKey: true
                    primaryKeyName: product_pkey
                  name: id
                  startWith: 3
                  type: INTEGER
              - column:
                  constraints:
                    nullable: false
                  name: doc
                  type: JSONB
            tableName: product
  - changeSet:
      id: initialMenu
      author: stephenatwell
      changes:
        - loadUpdateData:
            file: reference-data/menu_v1.csv
            relativeToChangelogFile: true
            tableName: menu
            primaryKey: id
  - changeSet:
      id: initialProducts
      author: stephenatwell
      changes:
        - delete:
            tableName: product
        - loadUpdateData:
            file: reference-data/product_v1.csv
            relativeToChangelogFile: true
            tableName: product
            primaryKey: id
      rollback:
        - delete:
            tableName: product
  - changeSet:
      id: initialLogins
      author: stephenatwell
      changes:
        - delete:
            tableName: registrations
        - loadUpdateData:
            file: reference-data/registrations_v1.csv
            relativeToChangelogFile: true
            tableName: registrations
            primaryKey: id
      rollback:
        - delete:
            tableName: registrations
  - changeSet:
      id: demostart
      author: stephenatwell
      changes:
        - tagDatabase:
            tag: demo-reset
  - changeSet:
      id: 202511060033-add-columns-from-doc-json-1
      author: Stephen Atwell
      comment: Add columns to extract JSON fields from doc column
      labels: myticket-123
      changes:
        - addColumn:
            tableName: orders
            columns:
              - column:
                  name: Main
                  type: VARCHAR(255)
              - column:
                  name: Drink
                  type: VARCHAR(255)
              - column:
                  name: Email
                  type: VARCHAR(255)
              - column:
                  name: Side1
                  type: VARCHAR(255)
              - column:
                  name: Side2
                  type: VARCHAR(255)
              - column:
                  name: OrderId
                  type: INTEGER
              - column:
                  name: OrderDate
                  type: TIMESTAMP
              - column:
                  name: OrderStatus
                  type: VARCHAR(50)
      rollback:
        - dropColumn:
            tableName: orders
            columnName: Main
        - dropColumn:
            tableName: orders
            columnName: Drink
        - dropColumn:
            tableName: orders
            columnName: Email
        - dropColumn:
            tableName: orders
            columnName: Side1
        - dropColumn:
            tableName: orders
            columnName: Side2
        - dropColumn:
            tableName: orders
            columnName: OrderId
        - dropColumn:
            tableName: orders
            columnName: OrderDate
        - dropColumn:
            tableName: orders
            columnName: OrderStatus
  - changeSet:
      id: 202511060033-populate-columns-from-doc-json-2
      author: Stephen Atwell
      comment: Populate new columns with data from doc JSON
      labels: myticket-123
      changes:
        - sql:
            splitStatements: false
            sql: "UPDATE orders\nSET \n  \"Main\" = doc::json->>'Main',\n  \"Drink\" = doc::json->>'Drink',\n  \"Email\" = doc::json->>'Email',\n  \"Side1\" = doc::json->>'Side1',\n  \"Side2\" = doc::json->>'Side2',\n  \"OrderId\" = (doc::json->>'OrderId')::INTEGER,\n  \"OrderDate\" = (doc::json->>'OrderDate')::TIMESTAMP,\n  \"OrderStatus\" = doc::json->>'OrderStatus'\n"
      rollback:
        - sql:
            splitStatements: false
            sql: "UPDATE orders\nSET \n  \"Main\" = NULL,\n  \"Drink\" = NULL,\n  \"Email\" = NULL,\n  \"Side1\" = NULL,\n  \"Side2\" = NULL,\n  \"OrderId\" = NULL,\n  \"OrderDate\" = NULL,\n  \"OrderStatus\" = NULL\n"
  - changeSet:
      id: 202511060033-create-trigger-for-doc-sync-3
      author: Stephen Atwell
      comment: Create trigger to keep doc and individual columns in sync
      labels: myticket-123
      changes:
        - sql:
            splitStatements: false
            sql: |
              -- Function to update doc from columns
              CREATE OR REPLACE FUNCTION update_doc_from_columns()
              RETURNS TRIGGER AS $$
              BEGIN
                NEW.doc = json_build_object(
                  'Main', NEW."Main",
                  'Drink', NEW."Drink",
                  'Email', NEW."Email",
                  'Side1', NEW."Side1",
                  'Side2', NEW."Side2",
                  'OrderId', NEW."OrderId",
                  'OrderDate', NEW."OrderDate",
                  'OrderStatus', NEW."OrderStatus"
                )::text;
                RETURN NEW;
              END;
              $$ LANGUAGE plpgsql;

              -- Function to update columns from doc
              CREATE OR REPLACE FUNCTION update_columns_from_doc()
              RETURNS TRIGGER AS $$
              BEGIN
                NEW."Main" = NEW.doc::json->>'Main';
                NEW."Drink" = NEW.doc::json->>'Drink';
                NEW."Email" = NEW.doc::json->>'Email';
                NEW."Side1" = NEW.doc::json->>'Side1';
                NEW."Side2" = NEW.doc::json->>'Side2';
                NEW."OrderId" = (NEW.doc::json->>'OrderId')::INTEGER;
                NEW."OrderDate" = (NEW.doc::json->>'OrderDate')::TIMESTAMP;
                NEW."OrderStatus" = NEW.doc::json->>'OrderStatus';
                RETURN NEW;
              END;
              $$ LANGUAGE plpgsql;

              -- Trigger for when columns are updated
              CREATE TRIGGER sync_doc_from_columns
              BEFORE UPDATE OF "Main", "Drink", "Email", "Side1", "Side2", "OrderId", "OrderDate", "OrderStatus"
              ON orders
              FOR EACH ROW
              WHEN (OLD.doc IS NOT DISTINCT FROM NEW.doc)
              EXECUTE FUNCTION update_doc_from_columns();

              -- Trigger for when doc is updated
              CREATE TRIGGER sync_columns_from_doc
              BEFORE UPDATE OF doc
              ON orders
              FOR EACH ROW
              WHEN (OLD.doc IS DISTINCT FROM NEW.doc)
              EXECUTE FUNCTION update_columns_from_doc();

              -- Trigger for new rows
              CREATE TRIGGER sync_new_rows
              BEFORE INSERT
              ON orders
              FOR EACH ROW
              EXECUTE FUNCTION update_columns_from_doc();
      rollback:
        - sql:
            splitStatements: false
            sql: |
              DROP TRIGGER IF EXISTS sync_doc_from_columns ON orders;
              DROP TRIGGER IF EXISTS sync_columns_from_doc ON orders;
              DROP TRIGGER IF EXISTS sync_new_rows ON orders;
              DROP FUNCTION IF EXISTS update_doc_from_columns();
              DROP FUNCTION IF EXISTS update_columns_from_doc();
